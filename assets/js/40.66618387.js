(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{553:function(t,e,r){"use strict";r.r(e);var s=r(5),a=Object(s.a)({},(function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("h1",{attrs:{id:"利用-travis-ci-github-实现持续集成和自动部署"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#利用-travis-ci-github-实现持续集成和自动部署"}},[t._v("#")]),t._v(" 利用 Travis CI+GitHub 实现持续集成和自动部署")]),t._v(" "),r("h1",{attrs:{id:"前言"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),r("p",[t._v("如果你手动部署过项目，一定会深感持续集成的必要性，因为手动部署实在又繁琐又耗时，虽然部署流程基本固定，依然还是容易出错。")]),t._v(" "),r("p",[t._v("如果你很熟悉持续集成，一定会同意这样的观点：“使用它已经成为一种标配”。")]),t._v(" "),r("blockquote",[r("p",[t._v("什么是持续集成 Continuous Integration(CI) is a development practice that requires developers to integrate code into a shared repository several times a day. Each check-in is then verified by an automated build, allowing teams to detect problems early. ———ThoughtWorks\n翻译过来就是：持续集成是一个开发行为，它要求开发者每天多次将代码集成到一个共享的仓库，每次提交都会被自动构建所检查，团队可因此提前检测出问题。")])]),t._v(" "),r("p",[t._v("持续集成的工具非常多，例如用 java 语言开发的 Jenkins，由于其可以在多台机器上进行分布式地构建和负载测试的特性，很多大公司都在使用它。")]),t._v(" "),r("p",[t._v("但是 Jenkins 的不加修饰的界面界面让我有些嫌弃...")]),t._v(" "),r("p",[t._v("随着 GitHub 的发展，出现了越来越多支持 GitHub 的 CI/CD 产品。在 GitHub 市场上，可以看到，已经支持的持续集成服务提供商已超过 300 多家（"),r("a",{attrs:{href:"https://github.com/marketplace/category/continuous-integration",target:"_blank",rel:"noopener noreferrer"}},[t._v("详情"),r("OutboundLink")],1),t._v("）。 选择 Travis CI，是因为身边很多朋友的推荐。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94b6d5fc0b82c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"github continuous integration.jpg"}})]),t._v(" "),r("p",[t._v("下面分享一下我是如何利用 Travis CI+GitHub 实现持续集成和自动部署的，通过我的一些研究和实战经验，希望可以帮到有需要的朋友。")]),t._v(" "),r("h2",{attrs:{id:"什么是-travis-ci"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#什么是-travis-ci"}},[t._v("#")]),t._v(" 什么是 Travis CI")]),t._v(" "),r("p",[t._v("Travis CI 是用 Ruby 语言开发的一个开源的分布式持续集成服务，用于自动构建和测试在 GitHub 托管的项目。支持包括 Javascript、Node.js、Ruby 等 20 多种程序语言。对于开源项目免费提供 CI 服务。你也可以买他的收费版，享受更多的服务。")]),t._v(" "),r("blockquote",[r("p",[t._v("Travis CI 目前有两个官网，分别是 "),r("a",{attrs:{href:"https://travis-ci.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("travis-ci.org"),r("OutboundLink")],1),t._v(" 和 "),r("a",{attrs:{href:"https://travis-ci.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("travis-ci.com"),r("OutboundLink")],1),t._v(" 。 "),r("a",{attrs:{href:"https://travis-ci.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("travis-ci.org"),r("OutboundLink")],1),t._v(" 是旧平台，已经逐渐往新平台 "),r("a",{attrs:{href:"https://travis-ci.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("travis-ci.com"),r("OutboundLink")],1),t._v(" 上迁移了。对于私有仓库的免费自动构建，Travis CI 在新平台上给予了支持。")])]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94bb042eed827?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-0.jpg"}})]),t._v(" "),r("h2",{attrs:{id:"一、获取-github-access-token"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#一、获取-github-access-token"}},[t._v("#")]),t._v(" 一、获取 GitHub Access Token")]),t._v(" "),r("p",[t._v("Travis CI 在自动部署的时候，需要 push 内容到仓库的某个分支，而访问 GitHub 仓库需要用户授权，授权方式就是用户提供 Access Token 给 Travis CI。")]),t._v(" "),r("p",[t._v("获取 token 的位置："),r("code",[t._v("GitHub->Settings->Developer Settings->Personal access tokens")]),t._v("。")]),t._v(" "),r("p",[t._v("勾选"),r("code",[t._v("repo")]),t._v("下的所有项，以及"),r("code",[t._v("user")]),t._v("下的"),r("code",[t._v("user:email")]),t._v("后，生成一个 token，复制 token 值。")]),t._v(" "),r("blockquote",[r("p",[t._v("注意：这个 token 只有现在可以看到，再次进入就看不到了，而且是再也看不到了，忘记了就只能重新生成了，所以要记住保管好。")])]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94e811e5d8fd1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"personal-access-token-variable.jpg"}})]),t._v(" "),r("h2",{attrs:{id:"二、使用-github-账号登录-travis"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#二、使用-github-账号登录-travis"}},[t._v("#")]),t._v(" 二、使用 GitHub 账号登录 Travis")]),t._v(" "),r("p",[t._v("进入"),r("a",{attrs:{href:"https://www.travis-ci.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Travis 官网"),r("OutboundLink")],1),t._v("，用 GitHub 账号登录。（我目前使用的是它的旧平台）")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94bf87bdf6696?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-ci-1.jpg"}})]),t._v(" "),r("p",[t._v("登录后，会在 Travis 里看到自己 GitHub 账号下所有的 public open source repo。")]),t._v(" "),r("h2",{attrs:{id:"三、开启对项目的监控"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#三、开启对项目的监控"}},[t._v("#")]),t._v(" 三、开启对项目的监控")]),t._v(" "),r("p",[t._v("选择目标项目，打开右侧开关。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94c01e2ac75b7?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-4.jpg"}})]),t._v(" "),r("h2",{attrs:{id:"四、配置-travis"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#四、配置-travis"}},[t._v("#")]),t._v(" 四、配置 travis")]),t._v(" "),r("ul",[r("li",[r("p",[t._v("点击开关右侧 Settings，进入该项目的 travis 配置页")])]),t._v(" "),r("li",[r("p",[t._v("勾选触发条件")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94c07b9d2ca62?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-7.jpg"}})])]),t._v(" "),r("li",[r("p",[t._v("设置全局变量")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94c0de02d4d8b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-8.jpg"}})]),t._v(" "),r("p",[t._v("注意：第一步获取的 access token，必须设置")]),t._v(" "),r("p",[t._v("设置好的变量可以在配置文件中以 ${变量名}来引用。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94c2446b08a02?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-9.jpg"}})])])]),t._v(" "),r("h2",{attrs:{id:"五、在项目根目录添加-travis-yml配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#五、在项目根目录添加-travis-yml配置文件"}},[t._v("#")]),t._v(" 五、在项目根目录添加"),r("code",[t._v(".travis.yml")]),t._v("配置文件")]),t._v(" "),r("blockquote",[r("p",[t._v("注意文件名以"),r("code",[t._v(".")]),t._v("开头。")])]),t._v(" "),r("p",[r("strong",[t._v("Travis CI 的一次构建分两个步骤：")])]),t._v(" "),r("ol",[r("li",[t._v("install 安装，安装任何所需的依赖")]),t._v(" "),r("li",[t._v("script 脚本，运行构建脚本")])]),t._v(" "),r("p",[r("strong",[t._v("Travis CI 提供了一些构建生命周期的“钩子”")])]),t._v(" "),r("p",[t._v("一个完整的 Travis CI 构建生命周期：")]),t._v(" "),r("ol",[r("li",[t._v("OPTIONAL Install "),r("code",[t._v("apt addons")])]),t._v(" "),r("li",[t._v("OPTIONAL Install "),r("code",[t._v("cache components")])]),t._v(" "),r("li",[r("code",[t._v("before_install")])]),t._v(" "),r("li",[r("code",[t._v("install")])]),t._v(" "),r("li",[r("code",[t._v("before_script")])]),t._v(" "),r("li",[r("code",[t._v("script")])]),t._v(" "),r("li",[t._v("OPTIONAL "),r("code",[t._v("before_cache")]),t._v("(for cleaning up cache)")]),t._v(" "),r("li",[r("code",[t._v("after_success")]),t._v(" or "),r("code",[t._v("after_failure")])]),t._v(" "),r("li",[t._v("OPTIONAL "),r("code",[t._v("before_deploy")])]),t._v(" "),r("li",[t._v("OPTIONAL "),r("code",[t._v("deploy")])]),t._v(" "),r("li",[t._v("OPTIONAL "),r("code",[t._v("after_deploy")])]),t._v(" "),r("li",[r("code",[t._v("after_script")])])]),t._v(" "),r("p",[t._v("在 "),r("code",[t._v("before_install")]),t._v("、"),r("code",[t._v("before_script")]),t._v("之前，或者"),r("code",[t._v("after_script")]),t._v("之后，都可以运行自定义命令，详细资料可参考官方文档："),r("a",{attrs:{href:"https://docs.travis-ci.com/user/job-lifecycle/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Job Lifecycle"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("我在"),r("code",[t._v("footprint")]),t._v("项目中的"),r("code",[t._v(".travis.yml")]),t._v("完整配置：")]),t._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[t._v('language: node_js #设置语言\n\nnode_js: "10.16.3" #设置语言版本\n\ncache:\n  directories:\n    - node_modules #缓存依赖\n\n# S: Build Lifecycle\ninstall:\n  - npm i\n\nscript:\n  - npm run build\n\n#after_script前5句是把部署分支的.git文件夹保护起来，用于保留历史部署的commit日志，否则部署分支永远只有一条commit记录。\n#命令里面的变量都是在Travis CI里配置过的。\nafter_script:\n  - git clone https://${GH_REF} .temp\n  - cd .temp\n  - git checkout gh-pages\n  - cd ../\n  - mv .temp/.git dist\n  - cd dist\n  - git config user.name "${U_NAME}"\n  - git config user.email "${U_EMAIL}"\n  - git add .\n  - git commit -m ":construction_worker:- Build & Deploy by Travis CI"\n  - git push --force --quiet "https://${Travis_Token}@${GH_REF}" gh-pages:${D_BRANCH}\n# E: Build LifeCycle\n\n# 只有指定的分支提交时才会运行脚本\nbranches:\n  only:\n    - master\n复制代码\n')])]),t._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[t._v("1")]),r("br"),r("span",{staticClass:"line-number"},[t._v("2")]),r("br"),r("span",{staticClass:"line-number"},[t._v("3")]),r("br"),r("span",{staticClass:"line-number"},[t._v("4")]),r("br"),r("span",{staticClass:"line-number"},[t._v("5")]),r("br"),r("span",{staticClass:"line-number"},[t._v("6")]),r("br"),r("span",{staticClass:"line-number"},[t._v("7")]),r("br"),r("span",{staticClass:"line-number"},[t._v("8")]),r("br"),r("span",{staticClass:"line-number"},[t._v("9")]),r("br"),r("span",{staticClass:"line-number"},[t._v("10")]),r("br"),r("span",{staticClass:"line-number"},[t._v("11")]),r("br"),r("span",{staticClass:"line-number"},[t._v("12")]),r("br"),r("span",{staticClass:"line-number"},[t._v("13")]),r("br"),r("span",{staticClass:"line-number"},[t._v("14")]),r("br"),r("span",{staticClass:"line-number"},[t._v("15")]),r("br"),r("span",{staticClass:"line-number"},[t._v("16")]),r("br"),r("span",{staticClass:"line-number"},[t._v("17")]),r("br"),r("span",{staticClass:"line-number"},[t._v("18")]),r("br"),r("span",{staticClass:"line-number"},[t._v("19")]),r("br"),r("span",{staticClass:"line-number"},[t._v("20")]),r("br"),r("span",{staticClass:"line-number"},[t._v("21")]),r("br"),r("span",{staticClass:"line-number"},[t._v("22")]),r("br"),r("span",{staticClass:"line-number"},[t._v("23")]),r("br"),r("span",{staticClass:"line-number"},[t._v("24")]),r("br"),r("span",{staticClass:"line-number"},[t._v("25")]),r("br"),r("span",{staticClass:"line-number"},[t._v("26")]),r("br"),r("span",{staticClass:"line-number"},[t._v("27")]),r("br"),r("span",{staticClass:"line-number"},[t._v("28")]),r("br"),r("span",{staticClass:"line-number"},[t._v("29")]),r("br"),r("span",{staticClass:"line-number"},[t._v("30")]),r("br"),r("span",{staticClass:"line-number"},[t._v("31")]),r("br"),r("span",{staticClass:"line-number"},[t._v("32")]),r("br"),r("span",{staticClass:"line-number"},[t._v("33")]),r("br"),r("span",{staticClass:"line-number"},[t._v("34")]),r("br"),r("span",{staticClass:"line-number"},[t._v("35")]),r("br"),r("span",{staticClass:"line-number"},[t._v("36")]),r("br")])]),r("h2",{attrs:{id:"done"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#done"}},[t._v("#")]),t._v(" Done！")]),t._v(" "),r("p",[t._v("将 "),r("code",[t._v(".travis.yml")]),t._v(" push 到远程，可以看到 travis 开始构建编译了。并且之后每次 push 代码，travis 都会自动执行"),r("code",[t._v(".travis.yml")]),t._v("里配置的脚本任务了。")]),t._v(" "),r("ul",[r("li",[r("p",[t._v("自动编译：")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94cb5439c34dc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-6.jpg"}})])])]),t._v(" "),r("ul",[r("li",[r("p",[t._v("构建完，travis 会根据我的配置，自动部署到 GitHub：")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94cbfac0a6c9d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-10.jpg"}})])])]),t._v(" "),r("h2",{attrs:{id:"and-one-more-thing"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#and-one-more-thing"}},[t._v("#")]),t._v(" And One More Thing")]),t._v(" "),r("p",[t._v("构建成功后，我们就可以在自己的 GitHub 项目里添加"),r("code",[t._v("build")]),t._v("徽章了。 方法：在 Travis 里，点击项目右侧的徽章，即可获取小徽章地址，将地址放在 README.md 文档中即可。")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94cd4721a614b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-12.jpg"}})]),t._v(" "),r("p",[t._v("效果：")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/4/16d94cdbbcc468b1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:"travis-CI-11.jpg"}})])])}),[],!1,null,null,null);e.default=a.exports}}]);